//= require polyfills
//= require helpers

//= require env

//= require animations
//= require event-handler
//= require legislator-querying
//= require map
//= require scroll-handler

//= require vendor/jquery.numberSpinner/src/jquery.numberSpinner.js

var legislators = {}; // Too lazy to pass this variable around to modals ATM - TODO

(function($, io) {

var
  LEGISLATORS_LOCATOR_URL = '<%= site.config['legislators_locator_url'] %>',
  SOCIAL_STATS_URL    = '<%= site.config['social_stats_url'] %>',

  TWEETS_READ_URL     = '<%= site.config['api_url'] + site.config['tweets_read_path'] %>',
  STATS_READ_URL      = '<%= site.config['api_url'] + site.config['stats_read_path'] %>',

  SEND_EMAIL_URL      = '<%= site.config['api_url'] + site.config['send_email_path'] %>',
  LOG_URL_BASE      = '<%= site.config['api_url'] + site.config['log_path'] %>'
;

// Start up scripts
$(function() {

  // ----------------- POP OVERS ----------------------------

  $('.metric').popover({
    trigger: 'hover',
    container: 'body',
    placement: 'top'
  });

  // ----------------- MODALS ----------------------------

  $('body').on('click', '.contact .call-action', function (e) {
    var legislatorId = $(e.currentTarget).parents('.legislator').attr('data-legislator-id');
    var legislator = legislators[legislatorId];
    var callModalTemplate = $('#call-modal-template').html();
    $('#call-modal-container').html(_.template(callModalTemplate, legislator));
    $('#call-modal-container .modal').modal();
  });

  $('body').on('click', '.contact .email-action', function (e) {
    var legislatorId = $(e.currentTarget).parents('.legislator').attr('data-legislator-id');
    var legislator = legislators[legislatorId];
    var emailModalTemplate = $('#email-modal-template').html();
    $('#email-modal-container').html(_.template(emailModalTemplate, legislator));
    $('#email-modal-container .modal').modal();
    $('#email-modal').modal();
  });

  // ---------- bring in metrics -----------

  ScrollHandler.addTrigger('#load-stats', animateStats);
  TweenLite.set(".stats .metric", { transform: "scaleX(0)", opacity: 0 });

  function animateStats()
  {
    TweenMax.staggerFromTo(".stats .metric", 0.2, { transform: "scaleX(0)", opacity: 0 }, { transform: "scaleX(1)", opacity: 1 }, 0.2);
    ScrollHandler.removeTrigger(animateStats);
  }

  function statsLoaded()
  {
    return loadedStats !== undefined && socialStats !== undefined;
  }

  function onStatsLoaded(data)
  {
    $('.email-total').numberSpinner('set', data.emails || 0);
    $('.call-total').numberSpinner('set', data.calls || 0);
    $('.view-total').numberSpinner('set', data.views || 0);
  }

  // ------------------------------ LOAD DATA ----------------------------------

  // GET AGGREGATE TOTALS

  io.emit('stats');

  // GET SOCIAL TOTALS

  $.ajax(SOCIAL_STATS_URL, {
      success: function(res, err) {
        $('.facebook-total').numberSpinner('set', res.facebook || 0);
        $('.google-total').numberSpinner('set', res.googleplus || 0);
        $('.twitter-total').numberSpinner('set', res.twitter || 0);
      },
      dataType: 'jsonp',
      cache         : true,
      jsonpCallback : 'myCallback'
  });

  // GET TWEETS

  io.emit('tweets');

  var tweetTemplate = $('#tweet-template').html();

  function onTweetsLoaded(tweetdata)
  {
    _.each(tweetdata.latest, function(tweets, type) {
      _.each(tweets, function(tweet) {
        $('#' + type + '-tweets').append(_.template(tweetTemplate, tweet));
      });
    });

    //$('.tweets-support-total').numberSpinner('set', tweetdata.total);

    $('.support img').popover({
      trigger: 'hover',
      container: 'body',
      placement: 'top'
    });
  }

  // SEND AN EMAIL (TEST ONLY)

  $.ajax({
    url: SEND_EMAIL_URL,
    type: "POST",

    contentType: "application/json",
    crossDomain: true,
    dataType: 'json',

    data: '{"some":"json"}',
    // work with the response
    success: function( res ) {
      console.log(res)
    }
  });

  // init live counter widgets

  $('.email-total, .call-total, .view-total, .facebook-total, .google-total, .twitter-total, \
    .tweets-support-total').addClass('number-spinner').numberSpinner();

  // LOG INITIAL VIEW

  io.emit('log', {'event' : 'views'});

  // -------------------------------- EXPORTS ----------------------------------

  STS.events.onStatsLoad = onStatsLoaded;
  STS.events.onTweetsLoad = onTweetsLoaded;

});

})(jQuery, STS.app);


// ---------------- API SERVER TOOLS -----------------------

var log = function(options) {
  var event = options.event;
  var legislator = options.legislator || null;
  /*$.ajax({
    url: STATS_READ_URL,
    jsonp: "callback",
    dataType: "jsonp",
    // work with the response
    success: function( response ) {
        console.log( response ); // server response
    }
  });*/
};
//log({event: 'view'});
